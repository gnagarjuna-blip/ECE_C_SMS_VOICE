<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECE Attendance Pro - G. Nagarjuna</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; padding-bottom: 280px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header { background: #1a237e; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; border-bottom: 4px solid #ffd600; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .student-item { background: white; margin: 8px; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; border-left: 8px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;}
        .is-a { border-left-color: #d32f2f; background: #fff5f5; }
        .is-p { border-left-color: #2e7d32; background: #f1f8f1; }
        .footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1001; }
        .perc-display { font-size: 1.6rem; font-weight: 800; color: #ffd600; line-height: 1; }
        .stats-label { font-size: 0.7rem; letter-spacing: 1px; font-weight: bold; }
        .btn-action { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="m-0 fw-bold">G. NAGARJUNA (ECE)</h5>
            <small id="date-time" class="opacity-75"></small>
        </div>
        <div class="text-end">
            <div id="perc-ui" class="perc-display">0%</div>
            <div class="stats-label">PRESENT</div>
        </div>
    </div>
    
    <div class="mt-3 row g-2">
        <div class="col-4">
            <select id="sec-sel" class="form-select form-select-sm shadow-sm" onchange="loadList()">
                <option value="A">Sec A</option>
                <option value="B">Sec B</option>
            </select>
        </div>
        <div class="col-4">
            <select id="period-sel" class="form-select form-select-sm shadow-sm" onchange="saveProgress()">
                <option value="P1">P1</option><option value="P2">P2</option><option value="P3">P3</option>
                <option value="P4">P4</option><option value="P5">P5</option><option value="P6">P6</option><option value="P7">P7</option>
            </select>
        </div>
        <div class="col-4">
            <div class="btn-group w-100 shadow-sm">
                <input type="radio" class="btn-check" name="m" id="p" value="P" checked>
                <label class="btn btn-outline-light btn-sm fw-bold" for="p">P</label>
                <input type="radio" class="btn-check" name="m" id="a" value="A">
                <label class="btn btn-outline-light btn-sm fw-bold" for="a">A</label>
            </div>
        </div>
    </div>
</div>

<div class="container mt-2" id="list"></div>

<div class="footer">
    <div class="mb-2 d-flex gap-2">
        <button class="btn btn-sm btn-warning w-50 fw-bold" onclick="saveProgress()">üíæ SAVE DATA</button>
        <button class="btn btn-sm btn-secondary w-50 fw-bold" onclick="resetAttendance()">üîÑ RESET</button>
    </div>
    <div class="mb-2">
        <textarea id="custom-msg" class="form-control form-control-sm" rows="1">ATTEDENCE Alert: ‡∞™‡±ç‡∞∞‡∞ø‡∞Ø ‡∞™‡±á‡∞∞‡±Ü‡∞Ç‡∞ü‡±ç,

        ‡∞à ‡∞∞‡±ã‡∞ú‡±Å ‡∞Æ‡±Ä ‡∞µ‡∞æ‡∞∞‡±ç‡∞°‡±ç ‡∞ï‡∞æ‡∞≤‡±á‡∞ú‡±ç ‡∞≤‡±ã ‡∞π‡∞æ‡∞ú‡∞∞‡±Å ‡∞ï‡∞æ‡∞≤‡±á‡∞¶‡∞®‡∞ø ‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞ú‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Æ‡±Å.Your ward is ABSENT today 
            BHARATH INSTITUTE OF EGINEERING TECHNOLOGY ,ECE DEPORTMENT.</textarea>
    </div>
    <div class="row g-2">
        <div class="col-12">
            <button class="btn btn-success w-100 fw-bold py-2 shadow-sm" onclick="shareGroupReport()">üöÄ WHATSAPP REPORT</button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-danger w-100 fw-bold btn-sm" onclick="sendVoiceSMS()">üé§ BULK SMS</button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-dark w-100 fw-bold btn-sm" onclick="copyToClipboard()">üìã COPY TEXT</button>
        </div>
    </div>
</div>

<script>
    const students = {
        "A": [
            {r: "24E11A04D9", n: "K.bharath", p: "919059144275"},
            {r: "24E11A0402", n: "P.Kumar", p: "919059144280"},
            {r: "24E11A0403", n: "Student 3", p: "9100000000"},
            {r: "24E11A0404", n: "Student 4", p: "9100000000"}
        ],
        "B": []
    };

    let att = {};
    const STORAGE_KEY = 'attendance_backup';

    function loadList() {
        const sec = document.getElementById('sec-sel').value;
        const container = document.getElementById('list');
        container.innerHTML = '';
        
        // Load from storage or default to Present
        const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        att = savedData[sec] || {};

        students[sec].forEach(s => {
            if (!att[s.r]) att[s.r] = 'P';
            
            const div = document.createElement('div');
            div.className = `student-item ${att[s.r] === 'P' ? 'is-p' : 'is-a'}`;
            div.id = `card-${s.r}`;
            div.innerHTML = `
                <div onclick="toggleAtt('${s.r}')" style="flex-grow:1;">
                    <strong class="d-block">${s.r}</strong>
                    <small class="text-muted">${s.n}</small>
                </div>
                <div class="d-flex gap-2">
                    <a href="tel:${s.p}" class="btn-action bg-primary text-white">üìû</a>
                </div>
            `;
            container.appendChild(div);
        });
        updateStats();
    }

    function toggleAtt(roll) {
        const mode = document.querySelector('input[name="m"]:checked').value;
        att[roll] = mode;
        const card = document.getElementById(`card-${roll}`);
        card.className = 'student-item ' + (mode === 'P' ? 'is-p' : 'is-a');
        updateStats();
        saveProgress(); // Auto-save on every click
    }

    function saveProgress() {
        const sec = document.getElementById('sec-sel').value;
        let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        savedData[sec] = att;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));
        console.log("Progress Saved");
    }

    function resetAttendance() {
        if(confirm("Clear all marks for this section?")) {
            att = {};
            saveProgress();
            loadList();
        }
    }

    function updateStats() {
        const sec = document.getElementById('sec-sel').value;
        const total = students[sec].length;
        if(total === 0) return;
        const present = Object.values(att).filter(v => v === 'P').length;
        document.getElementById('perc-ui').innerText = Math.round((present/total)*100) + '%';
    }

    function formatRollNumbers(absentees) {
        if (absentees.length === 0) return "None! All present.";
        
        let result = "";
        let currentPrefix = "";

        absentees.forEach((s, index) => {
            const roll = s.r;
            const prefix = roll.substring(0, roll.length - 2);
            const lastTwo = roll.substring(roll.length - 2);

            if (prefix !== currentPrefix) {
                result += (index === 0 ? "" : "\n") + roll;
                currentPrefix = prefix;
            } else {
                result += ", " + lastTwo;
            }
        });
        return result;
    }

    function generateReport() {
        const sec = document.getElementById('sec-sel').value;
        const period = document.getElementById('period-sel').value;
        const absList = students[sec].filter(s => att[s.r] === 'A');
        const total = students[sec].length;
        const presentCount = total - absList.length;
        const date = new Date().toLocaleDateString();

        return `üìä *ATTENDANCE REPORT*
üìù *Subject:* ECA
üë®‚Äçüè´ *Faculty:* G.Nagarjuna
üìå *Section:* ${sec} (${period})
üìÖ *Date:* ${date}
‚úÖ *Present:* ${presentCount}
‚ùå *Absent:* ${absList.length}
üìà *Percentage:* ${document.getElementById('perc-ui').innerText}

üö´ *ABSENTEES:*
${formatRollNumbers(absList)}

_Generated by ECE Attendance System_`;
    }

    function shareGroupReport() {
        const report = generateReport();
        window.open(`https://wa.me/?text=${encodeURIComponent(report)}`, '_blank');
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(generateReport());
        alert("Report copied!");
    }

    function sendVoiceSMS() {
        const sec = document.getElementById('sec-sel').value;
        const abs = students[sec].filter(s => att[s.r] === 'A');
        if (abs.length === 0) return alert("No absentees!");
        const numbers = abs.map(s => s.p).join(/iPad|iPhone|iPod/.test(navigator.userAgent) ? ',' : ';');
        window.location.href = `sms:${numbers}?body=${encodeURIComponent(document.getElementById('custom-msg').value)}`;
    }

    document.getElementById('date-time').innerText = new Date().toDateString();
    window.onload = loadList;
</script>
</body>
</html>
